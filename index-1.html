<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion FTTH</title>
    <!-- CDN pour Chart.js (graphiques) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- CDN pour html2canvas (export image) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- CDN pour jsPDF (export PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Ajout du CDN Tesseract.js pour OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid #1e3c72;
        }

        .header h1 {
            text-align: center;
            color: #1e3c72;
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            text-align: center;
            color: #666;
            font-size: 1.1em;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #1e3c72;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .table-header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-box {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .status-pending {
            background: #fff3e0;
            color: #ff9800;
        }

        .status-completed {
            background: #e3f2fd;
            color: #1e3c72;
        }

        .status-cancelled {
            background: #ffebee;
            color: #f44336;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #1e3c72;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .report-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #1e3c72;
        }

        .chart-container {
            max-width: 600px;
            margin: 20px auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .report-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .report-table th, .report-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .report-table th {
            background: #1e3c72;
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .buttons {
                flex-direction: column;
            }
            .search-box {
                width: 100%;
                margin-top: 10px;
            }
            .table-header {
                flex-direction: column;
                gap: 15px;
            }
            table {
                font-size: 14px;
            }
            th, td {
                padding: 10px;
            }
            .report-header {
                flex-direction: column;
                gap: 10px;
            }
        }
        /* Ajout d'un breakpoint mobile amélioré */
        @media (max-width: 600px) {
            .container {
                padding: 10px 2px;
            }
            .control-panel {
                padding: 10px;
                margin-bottom: 15px;
            }
            .form-section, .report-section {
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 10px;
            }
            .form-grid, .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .buttons {
                flex-direction: column;
                gap: 8px;
            }
            .tab {
                padding: 10px 8px;
                font-size: 14px;
            }
            .tab-content {
                padding: 5px;
            }
            .data-table {
                margin-top: 10px;
                border-radius: 8px;
            }
            .table-header {
                flex-direction: column;
                gap: 8px;
                padding: 10px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 6px;
            }
            .search-box {
                width: 100%;
                margin-top: 5px;
            }
            .stat-card {
                padding: 10px;
                border-radius: 8px;
            }
            .stat-number {
                font-size: 1.5em;
            }
            .report-header {
                flex-direction: column;
                gap: 8px;
            }
            .chart-container {
                max-width: 100%;
                margin: 10px auto;
            }
        }
        /* Amélioration du responsive pour les boutons et formulaires */
        input, select, button {
            font-size: 15px;
        }
        label {
            font-size: 13px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Système de Gestion FTTH</h1>
        <p>Gestion efficace des dossiers d'installation Fibre Optique</p>
    </div>

    <div class="container">
        <div class="control-panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">Tableau de Bord</button>
                <button class="tab" onclick="switchTab('add-client')">Ajouter Client</button>
                <button class="tab" onclick="switchTab('manage')">Gestion</button>
                <button class="tab" onclick="switchTab('export')">Export & Rapports</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeInstallations">0</div>
                        <div class="stat-label">Installations Actives</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingInstallations">0</div>
                        <div class="stat-label">En Attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedToday">0</div>
                        <div class="stat-label">Terminées Aujourd'hui</div>
                    </div>
                </div>
            </div>

            <!-- Add Client Tab -->
            <div id="add-client" class="tab-content">
                <div class="form-section">
                    <h3 style="margin-bottom: 20px; color: #1e3c72;">
                        <span id="formTitle">Nouveau Client FTTH</span>
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="clientName">Nom et Prénoms *</label>
                            <input type="text" id="clientName" placeholder="Ex: TOHOUA HERVE OSCAR" required>
                        </div>
                        <div class="form-group">
                            <label for="contactPrincipal">Contact Principal *</label>
                            <input type="tel" id="contactPrincipal" placeholder="Ex: 0555588630" pattern="[0-9]{10}" required>
                        </div>
                        <div class="form-group">
                            <label for="contactSecondaire">Contact Secondaire</label>
                            <input type="tel" id="contactSecondaire" placeholder="Ex: 0585530043" pattern="[0-9]{10}">
                        </div>
                        <div class="form-group">
                            <label for="ville">Ville/Commune *</label>
                            <select id="ville" required>
                                <option value="">Sélectionner...</option>
                                <option value="ABOBO">ABOBO</option>
                                <option value="ADJAME">ADJAME</option>
                                <option value="COCODY">COCODY</option>
                                <option value="YOPOUGON">YOPOUGON</option>
                                <option value="MARCORY">MARCORY</option>
                                <option value="TREICHVILLE">TREICHVILLE</option>
                                <option value="PLATEAU">PLATEAU</option>
                                <option value="PORT-BOUET">PORT-BOUET</option>
                                <option value="KOUMASSI">KOUMASSI</option>
                                <option value="BINGERVILLE">BINGERVILLE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quartier">Quartier d'habitation</label>
                            <input type="text" id="quartier" placeholder="Ex: Bandji nouvelle cassee">
                        </div>
                        <div class="form-group">
                            <label for="numeroFTTH">Numéro FTTH (TN)</label>
                            <input type="text" id="numeroFTTH" placeholder="Ex: 2536070716@mtn.ci">
                        </div>
                        <div class="form-group">
                            <label for="statusInstallation">Statut Installation</label>
                            <select id="statusInstallation">
                                <option value="pending">En Attente</option>
                                <option value="active">Active</option>
                                <option value="completed">Terminée</option>
                                <option value="cancelled">Annulée</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateInstallation">Date d'Installation</label>
                            <input type="date" id="dateInstallation">
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn-primary" onclick="addClient()">
                            <span id="saveButtonText">Ajouter Client</span>
                        </button>
                        <button class="btn-warning" onclick="clearAddForm()">Effacer</button>
                        <!-- Nouveau bouton pour importer depuis une image -->
                        <input type="file" id="imageImport" accept="image/*" style="display:none" onchange="importClientsFromImage(event)">
                        <button class="btn-success" onclick="document.getElementById('imageImport').click()">Importer depuis une image</button>
                    </div>
                </div>
            </div>

            <!-- Manage Tab -->
            <div id="manage" class="tab-content">
                <div class="buttons">
                    <button class="btn-success" onclick="loadSampleData()">Charger Données Exemple</button>
                    <button class="btn-warning" onclick="exportToCSV()">Exporter CSV</button>
                    <button class="btn-danger" onclick="clearAllData()">Effacer Tout</button>
                </div>
            </div>

            <!-- Export & Reports Tab -->
            <div id="export" class="tab-content">
                <div class="export-section">
                    <h3 style="margin-bottom: 20px; color: #1e3c72;">Options d'Export</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="exportFormat">Format d'Export</label>
                            <select id="exportFormat">
                                <option value="csv">CSV (Excel)</option>
                                <option value="json">JSON</option>
                                <option value="txt">Texte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exportFilter">Filtrer par Statut</label>
                            <select id="exportFilter">
                                <option value="all">Tous</option>
                                <option value="active">Actifs</option>
                                <option value="pending">En Attente</option>
                                <option value="completed">Terminés</option>
                                <option value="cancelled">Annulés</option>
                            </select>
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn-primary" onclick="performExport()">Télécharger Export</button>
                        <button class="btn-success" onclick="copyToClipboard()">Copier Données</button>
                    </div>
                </div>
                <div class="report-section">
                    <div class="report-header">
                        <h3 style="color: #1e3c72;">Rapport des Statuts</h3>
                        <div class="buttons">
                            <select id="reportPeriod" onchange="generateReport()">
                                <option value="all">Toutes les périodes</option>
                                <option value="today">Aujourd'hui</option>
                                <option value="week">Cette semaine</option>
                                <option value="month">Ce mois</option>
                            </select>
                            <button class="btn-primary" onclick="exportReportAsImage()">Exporter Image</button>
                            <button class="btn-success" onclick="exportReportAsPDF()">Exporter PDF</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Statut</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table">
            <div class="table-header">
                <h3>Liste des Clients FTTH</h3>
                <input type="text" class="search-box" id="searchBox" placeholder="Rechercher client..." onkeyup="searchClients()">
            </div>
            <table id="clientTable">
                <thead>
                    <tr>
                        <th>Nom et Prénoms</th>
                        <th>Contact Principal</th>
                        <th>Contact Secondaire</th>
                        <th>Ville/Commune</th>
                        <th>Quartier</th>
                        <th>Numéro FTTH</th>
                        <th>Statut</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="notification" id="notification">
        Action effectuée avec succès !
    </div>

    <script>
        let clients = JSON.parse(localStorage.getItem('ftthClients')) || [];
        let currentEditId = null;
        let statusChart = null;

        // Vérifier si les dépendances sont chargées
        window.addEventListener('load', () => {
            if (!window.Chart || !window.html2canvas || !window.jspdf) {
                showNotification('Erreur : Certaines dépendances (Chart.js, html2canvas, jsPDF) n\'ont pas été chargées. Vérifiez votre connexion Internet.', '#f44336');
            } else {
                updateClientTable();
                updateDashboardStats();
                generateReport();
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                updateDashboardStats();
            } else if (tabName === 'export') {
                generateReport();
            }
        }

        function validatePhoneNumber(phone) {
            const phoneRegex = /^[0-9]{10}$/;
            return phone === '' || phoneRegex.test(phone);
        }

        function addClient() {
            const clientData = {
                id: currentEditId || Date.now(),
                nom: document.getElementById('clientName').value.trim(),
                contactPrincipal: document.getElementById('contactPrincipal').value.trim(),
                contactSecondaire: document.getElementById('contactSecondaire').value.trim(),
                ville: document.getElementById('ville').value,
                quartier: document.getElementById('quartier').value.trim(),
                numeroFTTH: document.getElementById('numeroFTTH').value.trim(),
                status: document.getElementById('statusInstallation').value,
                dateInstallation: document.getElementById('dateInstallation').value,
                dateCreation: currentEditId ? clients.find(c => c.id === currentEditId)?.dateCreation || new Date().toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
            };

            if (!clientData.nom || !clientData.contactPrincipal || !clientData.ville) {
                showNotification('Veuillez remplir tous les champs obligatoires (*) !', '#f44336');
                return;
            }

            if (!validatePhoneNumber(clientData.contactPrincipal) || !validatePhoneNumber(clientData.contactSecondaire)) {
                showNotification('Les numéros de téléphone doivent contenir 10 chiffres !', '#f44336');
                return;
            }

            if (currentEditId) {
                const index = clients.findIndex(client => client.id === currentEditId);
                if (index !== -1) {
                    clients[index] = clientData;
                    showNotification('Client modifié avec succès !');
                    currentEditId = null;
                    document.getElementById('formTitle').textContent = 'Nouveau Client FTTH';
                    document.getElementById('saveButtonText').textContent = 'Ajouter Client';
                }
            } else {
                clients.push(clientData);
                showNotification('Client ajouté avec succès !');
            }

            localStorage.setItem('ftthClients', JSON.stringify(clients));
            updateClientTable();
            updateDashboardStats();
            generateReport();
            clearAddForm();
        }

        function clearAddForm() {
            document.getElementById('clientName').value = '';
            document.getElementById('contactPrincipal').value = '';
            document.getElementById('contactSecondaire').value = '';
            document.getElementById('ville').value = '';
            document.getElementById('quartier').value = '';
            document.getElementById('numeroFTTH').value = '';
            document.getElementById('statusInstallation').value = 'pending';
            document.getElementById('dateInstallation').value = '';
            currentEditId = null;
            document.getElementById('formTitle').textContent = 'Nouveau Client FTTH';
            document.getElementById('saveButtonText').textContent = 'Ajouter Client';
        }

        function updateClientTable(filteredClients = clients) {
            const tableBody = document.getElementById('clientTableBody');
            tableBody.innerHTML = '';

            filteredClients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.nom}</td>
                    <td>${client.contactPrincipal}</td>
                    <td>${client.contactSecondaire || '-'}</td>
                    <td>${client.ville}</td>
                    <td>${client.quartier || '-'}</td>
                    <td>${client.numeroFTTH || '-'}</td>
                    <td><span class="status-badge status-${client.status}">${getStatusText(client.status)}</span></td>
                    <td>${client.dateInstallation || client.dateCreation}</td>
                    <td class="action-buttons">
                        <button class="btn-primary btn-small" onclick="editClient(${client.id})">Modifier</button>
                        <button class="btn-danger btn-small" onclick="deleteClient(${client.id})">Supprimer</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                pending: 'En Attente',
                active: 'Active',
                completed: 'Terminée',
                cancelled: 'Annulée'
            };
            return statusMap[status] || status;
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (client) {
                currentEditId = id;
                document.getElementById('clientName').value = client.nom;
                document.getElementById('contactPrincipal').value = client.contactPrincipal;
                document.getElementById('contactSecondaire').value = client.contactSecondaire || '';
                document.getElementById('ville').value = client.ville;
                document.getElementById('quartier').value = client.quartier || '';
                document.getElementById('numeroFTTH').value = client.numeroFTTH || '';
                document.getElementById('statusInstallation').value = client.status;
                document.getElementById('dateInstallation').value = client.dateInstallation || '';
                
                document.getElementById('formTitle').textContent = 'Modifier Client FTTH';
                document.getElementById('saveButtonText').textContent = 'Modifier Client';
                
                switchTab('add-client');
                showNotification('Mode édition activé !');
            }
        }

        function deleteClient(id) {
            if (confirm('Voulez-vous vraiment supprimer ce client ?')) {
                clients = clients.filter(client => client.id !== id);
                localStorage.setItem('ftthClients', JSON.stringify(clients));
                updateClientTable();
                updateDashboardStats();
                generateReport();
                showNotification('Client supprimé avec succès !');
            }
        }

        function searchClients() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filteredClients = clients.filter(client =>
                client.nom.toLowerCase().includes(searchTerm) ||
                client.contactPrincipal.includes(searchTerm) ||
                (client.contactSecondaire && client.contactSecondaire.includes(searchTerm)) ||
                client.ville.toLowerCase().includes(searchTerm) ||
                (client.quartier && client.quartier.toLowerCase().includes(searchTerm)) ||
                (client.numeroFTTH && client.numeroFTTH.toLowerCase().includes(searchTerm))
            );
            updateClientTable(filteredClients);
        }

        function updateDashboardStats() {
            const totalClients = clients.length;
            const activeInstallations = clients.filter(c => c.status === 'active').length;
            const pendingInstallations = clients.filter(c => c.status === 'pending').length;
            const today = new Date().toISOString().split('T')[0];
            const completedToday = clients.filter(c => c.dateInstallation === today && c.status === 'completed').length;

            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('activeInstallations').textContent = activeInstallations;
            document.getElementById('pendingInstallations').textContent = pendingInstallations;
            document.getElementById('completedToday').textContent = completedToday;
        }

        function loadSampleData() {
            const sampleData = [
                {
                    id: Date.now() + 1,
                    nom: "KOFFI KOUAKOU JEAN",
                    contactPrincipal: "0555588630",
                    contactSecondaire: "0585530043",
                    ville: "COCODY",
                    quartier: "Angré",
                    numeroFTTH: "2536070716@mtn.ci",
                    status: "active",
                    dateInstallation: "2025-09-10",
                    dateCreation: "2025-09-01"
                },
                {
                    id: Date.now() + 2,
                    nom: "YAO AMA ELISE",
                    contactPrincipal: "0777889900",
                    contactSecondaire: "",
                    ville: "YOPOUGON",
                    quartier: "Siporex",
                    numeroFTTH: "2536070717@mtn.ci",
                    status: "pending",
                    dateInstallation: "",
                    dateCreation: "2025-09-05"
                }
            ];

            clients = [...sampleData];
            localStorage.setItem('ftthClients', JSON.stringify(clients));
            updateClientTable();
            updateDashboardStats();
            generateReport();
            showNotification('Données exemple chargées !');
        }

        function exportToCSV() {
            const filter = document.getElementById('exportFilter').value;
            let filteredClients = filter === 'all' ? clients : clients.filter(c => c.status === filter);

            const headers = ['Nom', 'Contact Principal', 'Contact Secondaire', 'Ville', 'Quartier', 'Numéro FTTH', 'Statut', 'Date Installation', 'Date Création'];
            const csvContent = [
                headers.join(','),
                ...filteredClients.map(client =>
                    [
                        `"${client.nom}"`,
                        client.contactPrincipal,
                        client.contactSecondaire || '-',
                        client.ville,
                        client.quartier || '-',
                        client.numeroFTTH || '-',
                        getStatusText(client.status),
                        client.dateInstallation || '-',
                        client.dateCreation
                    ].join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ftth_clients_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('Export CSV effectué !');
        }

        function performExport() {
            const format = document.getElementById('exportFormat').value;
            const filter = document.getElementById('exportFilter').value;
            let filteredClients = filter === 'all' ? clients : clients.filter(c => c.status === filter);

            if (format === 'csv') {
                exportToCSV();
            } else if (format === 'json') {
                const blob = new Blob([JSON.stringify(filteredClients, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ftth_clients_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                showNotification('Export JSON effectué !');
            } else if (format === 'txt') {
                const txtContent = filteredClients.map(client =>
                    `Nom: ${client.nom}\n` +
                    `Contact Principal: ${client.contactPrincipal}\n` +
                    `Contact Secondaire: ${client.contactSecondaire || '-'}\n` +
                    `Ville: ${client.ville}\n` +
                    `Quartier: ${client.quartier || '-'}\n` +
                    `Numéro FTTH: ${client.numeroFTTH || '-'}\n` +
                    `Statut: ${getStatusText(client.status)}\n` +
                    `Date Installation: ${client.dateInstallation || '-'}\n` +
                    `Date Création: ${client.dateCreation}\n` +
                    `------------------------`
                ).join('\n');
                
                const blob = new Blob([txtContent], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ftth_clients_${new Date().toISOString().split('T')[0]}.txt`;
                link.click();
                showNotification('Export TXT effectué !');
            }
        }

        function copyToClipboard() {
            const filter = document.getElementById('exportFilter').value;
            let filteredClients = filter === 'all' ? clients : clients.filter(c => c.status === filter);
            
            const textContent = filteredClients.map(client =>
                `Nom: ${client.nom}\n` +
                `Contact Principal: ${client.contactPrincipal}\n` +
                `Contact Secondaire: ${client.contactSecondaire || '-'}\n` +
                `Ville: ${client.ville}\n` +
                `Quartier: ${client.quartier || '-'}\n` +
                `Numéro FTTH: ${client.numeroFTTH || '-'}\n` +
                `Statut: ${getStatusText(client.status)}\n` +
                `Date Installation: ${client.dateInstallation || '-'}\n` +
                `Date Création: ${client.dateCreation}`
            ).join('\n\n');

            navigator.clipboard.writeText(textContent).then(() => {
                showNotification('Données copiées dans le presse-papiers !');
            }).catch(() => {
                showNotification('Erreur lors de la copie dans le presse-papiers !', '#f44336');
            });
        }

        function clearAllData() {
            if (confirm('Voulez-vous vraiment supprimer toutes les données ? Cette action est irréversible.')) {
                clients = [];
                localStorage.setItem('ftthClients', JSON.stringify(clients));
                updateClientTable();
                updateDashboardStats();
                generateReport();
                showNotification('Toutes les données ont été supprimées !');
            }
        }

        function showNotification(message, bgColor = '#4CAF50') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = bgColor;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function filterByPeriod(clients, period) {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const weekAgo = new Date(today.setDate(today.getDate() - 7)).toISOString().split('T')[0];
            const monthAgo = new Date(today.setMonth(today.getMonth() - 1)).toISOString().split('T')[0];

            if (period === 'today') {
                return clients.filter(c => c.dateInstallation === todayStr || c.dateCreation === todayStr);
            } else if (period === 'week') {
                return clients.filter(c => (c.dateInstallation && c.dateInstallation >= weekAgo) || c.dateCreation >= weekAgo);
            } else if (period === 'month') {
                return clients.filter(c => (c.dateInstallation && c.dateInstallation >= monthAgo) || c.dateCreation >= monthAgo);
            }
            return clients;
        }

        function generateReport() {
            if (!window.Chart) {
                showNotification('Erreur : Chart.js non chargé. Le graphique ne peut pas être affiché.', '#f44336');
                return;
            }

            const period = document.getElementById('reportPeriod').value;
            const filteredClients = filterByPeriod(clients, period);

            const stats = {
                pending: filteredClients.filter(c => c.status === 'pending').length,
                active: filteredClients.filter(c => c.status === 'active').length,
                completed: filteredClients.filter(c => c.status === 'completed').length,
                cancelled: filteredClients.filter(c => c.status === 'cancelled').length
            };

            const total = stats.pending + stats.active + stats.completed + stats.cancelled;
            const reportTableBody = document.getElementById('reportTableBody');
            reportTableBody.innerHTML = '';

            const statuses = [
                { key: 'pending', label: 'En Attente', color: '#ff9800' },
                { key: 'active', label: 'Active', color: '#4CAF50' },
                { key: 'completed', label: 'Terminée', color: '#1e3c72' },
                { key: 'cancelled', label: 'Annulée', color: '#f44336' }
            ];

            statuses.forEach(status => {
                const percentage = total > 0 ? ((stats[status.key] / total) * 100).toFixed(1) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="status-badge status-${status.key}">${status.label}</span></td>
                    <td>${stats[status.key]}</td>
                    <td>${percentage}%</td>
                `;
                reportTableBody.appendChild(row);
            });

            if (statusChart) {
                statusChart.destroy();
            }

            const ctx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: statuses.map(s => s.label),
                    datasets: [{
                        data: [stats.pending, stats.active, stats.completed, stats.cancelled],
                        backgroundColor: statuses.map(s => s.color),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 14, family: 'Segoe UI' } }
                        },
                        title: {
                            display: true,
                            text: `Répartition des Statuts (${period === 'all' ? 'Toutes périodes' : period === 'today' ? 'Aujourd\'hui' : period === 'week' ? 'Cette semaine' : 'Ce mois'})`,
                            font: { size: 16, weight: 'bold' },
                            color: '#1e3c72'
                        }
                    }
                }
            });
        }

        function exportReportAsImage() {
            if (!window.html2canvas) {
                showNotification('Erreur : html2canvas non chargé. Impossible d\'exporter l\'image.', '#f44336');
                return;
            }

            const chartContainer = document.querySelector('.chart-container');
            html2canvas(chartContainer).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `ftth_report_${new Date().toISOString().split('T')[0]}.png`;
                link.click();
                showNotification('Rapport exporté en image !');
            }).catch(() => {
                showNotification('Erreur lors de l\'exportation de l\'image !', '#f44336');
            });
        }

        function exportReportAsPDF() {
            if (!window.jspdf || !window.html2canvas) {
                showNotification('Erreur : jsPDF ou html2canvas non chargé. Impossible d\'exporter le PDF.', '#f44336');
                return;
            }

            const { jsPDF } = window.jspdf;
            const chartContainer = document.querySelector('.chart-container');
            html2canvas(chartContainer).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF();
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(16);
                pdf.text('Rapport des Statuts FTTH', 20, 20);
                
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 20, 30, pdfWidth - 40, pdfHeight - 40);

                pdf.setFontSize(12);
                pdf.text('Résumé des Statuts', 20, pdfHeight + 50);
                const reportTableBody = document.getElementById('reportTableBody');
                let y = pdfHeight + 60;
                reportTableBody.querySelectorAll('tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    pdf.text(`${cells[0].textContent}: ${cells[1].textContent} (${cells[2].textContent})`, 20, y);
                    y += 10;
                });

                pdf.save(`ftth_report_${new Date().toISOString().split('T')[0]}.pdf`);
                showNotification('Rapport exporté en PDF !');
            }).catch(() => {
                showNotification('Erreur lors de l\'exportation du PDF !', '#f44336');
            });
        }

        // Fonction d'importation de clients depuis une image de tableau (améliorée)
        async function importClientsFromImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            showNotification('Analyse de l\'image en cours...');
            try {
                const result = await Tesseract.recognize(file, 'fra', { logger: m => console.log(m) });
                const text = result.data.text;
                if (!text || text.trim().length < 10) {
                    showNotification('Aucun texte détecté. Essayez une image plus nette ou un tableau plus lisible.', '#f44336');
                    return;
                }
                // Affichage du texte extrait pour vérification
                alert('Texte extrait :\n' + text);
                // Découpage des lignes et colonnes
                const rows = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                let imported = 0;
                rows.forEach(row => {
                    // Découpage par tabulation, point-virgule ou espaces multiples
                    const cols = row.split(/\t|;| {2,}/);
                    // On suppose l'ordre des colonnes comme sur l'image :
                    // Nom, Contact, Second contact, Ville, Quartier, Numéro FTTH
                    if (cols.length >= 6 && cols[0].length > 2 && /[0-9]{8,}/.test(cols[2])) {
                        const clientData = {
                            id: Date.now() + Math.floor(Math.random()*10000),
                            nom: cols[0].trim(),
                            contactPrincipal: cols[2].trim(),
                            contactSecondaire: cols[3].trim(),
                            ville: cols[4].trim(),
                            quartier: cols[5].trim(),
                            numeroFTTH: cols[6] ? cols[6].trim() : '',
                            status: 'pending',
                            dateInstallation: '',
                            dateCreation: new Date().toISOString().split('T')[0]
                        };
                        clients.push(clientData);
                        imported++;
                    }
                });
                if (imported === 0) {
                    showNotification('Aucune ligne client détectée. Vérifiez le format du tableau.', '#f44336');
                    return;
                }
                localStorage.setItem('ftthClients', JSON.stringify(clients));
                updateClientTable();
                updateDashboardStats();
                generateReport();
                showNotification(imported + ' client(s) importé(s) !');
            } catch (e) {
                showNotification('Erreur lors de l\'analyse de l\'image.', '#f44336');
            }
        }
    </script>
</body>
</html>
